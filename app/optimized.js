var app=angular.module("ajaxApp",["ngAnimate","ui.bootstrap","ngRoute","LocalStorageModule","angular-loading-bar","ui.grid","ui.grid.selection","angular.filter","ngCookies"]);app.config(["$routeProvider","$locationProvider",function(a,b){a.when("/product",{controller:"productController",templateUrl:"app/views/products.html"}),a.when("/login",{controller:"loginController",templateUrl:"app/views/login.html"}),a.when("/signup",{controller:"signupController",templateUrl:"app/views/signup.html"}),a.when("/home",{controller:"loginController",templateUrl:"app/views/home.html"}),a.when("/associate",{controller:"associateController",templateUrl:"app/views/associate.html"}),a.otherwise({redirectTo:"/home"})}]),app.constant("serviceSetting",{apiServiceBaseUri:"http://duckbar-001-site1.myasp.net"}),app.config(["$httpProvider",function(a){a.interceptors.push("requestInterceptor")}]),app.run(["authenticationService",function(a){a.getAuthData()}]),app.service("requestInterceptor",["$q","$location","localStorageService",function(a,b,c){this.request=function(a){a.headers||(a.headers={});var b=c.get("authorizationData");return b&&(a.headers.Authorization="Bearer "+b.token),a},this.responseError=function(d){return 401===d.status&&(c.remove("authorizationData"),b.path("/login")),a.reject(d)}}]),app.service("authenticationService",["$http","$q","localStorageService","serviceSetting",function(a,b,c,d){var e=d.apiServiceBaseUri,f=this,g={isAuth:!1,userName:""};this.authenticationStatus=g;var h={provider:"",userName:"",externalAccessToken:""};this.externalAuthData=h,this.login=function(d){var f=b.defer(),h="grant_type=password&username="+d.username+"&password="+d.password;return a({method:"POST",url:e+"/token",data:h,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a){c.set("authorizationData",{token:a.access_token,userName:a.userName}),g.isAuth=!0,g.userName=a.userName,f.resolve(a.data)}).error(function(a){f.reject(angular.isObject(a)&&a.error_description?a.error_description:"Login Failed!")}),f.promise},this.logOut=function(){c.remove("authorizationData"),g.isAuth=!1,g.userName=""},this.getAuthData=function(){var a=c.get("authorizationData");return a?(g.isAuth=!0,g.userName=a.userName):(g.isAuth=!1,g.userName=""),g},this.signup=function(c){var d=b.defer(),f={Email:c.email,Password:c.password,ConfirmPassword:c.confirmPassword};return a({method:"POST",url:e+"/api/account/register",data:f}).success(function(a){d.resolve("User registered!")}).error(function(a){d.reject(angular.isObject(a)&&a.ModelState?a.ModelState:"Login Failed!")}),d.promise},this.obtainAccessToken=function(d){var h=b.defer();return a.get(e+"/api/account/ObtainLocalAccessToken",{params:{provider:d.provider,externalAccessToken:d.externalAccessToken}}).success(function(a){c.set("authorizationData",{token:a.access_token,userName:a.userName}),g.isAuth=!0,g.userName=a.userName,h.resolve(a)}).error(function(a,b){f.logOut(),h.reject(angular.isObject(response)&&response.ModelState?response.ModelState:"Login Failed!")}),h.promise},this.registerExternal=function(d){var h=b.defer();return a.post(e+"/api/account/registerexternal",d).success(function(a){c.set("authorizationData",{token:a.access_token,userName:a.userName}),g.isAuth=!0,g.userName=a.userName,h.resolve(a)}).error(function(a,b){f.logOut(),h.reject(a.ModelState)}),h.promise}}]),app.service("productService",["$http","$q","serviceSetting",function(a,b,c){var d=c.apiServiceBaseUri;this.getProduct=function(){var c=b.defer();return a({method:"Get",url:d+"/api/products/list"}).success(function(a){c.resolve(a)}).error(function(a){c.reject(a.Message?a.Message:"Internal error!")}),c.promise}}]),app.service("utilityService",[function(){this.constructAlerts=function(a,b){var c=[];return angular.forEach(a,function(a,d){var e={msg:a,type:b};c.push(e)}),c},this.pushArray=function(a,b){a.push.apply(a,b)}}]),app.controller("navController",["$scope","$location","authenticationService","$cookies",function(a,b,c){a.logOutClick=function(){c.logOut(),b.path("/home")},a.authData=c.getAuthData(),a.SetCollapse=function(){a.navCollapsed=!0}}]),app.controller("loginController",["$scope","authenticationService","$location","utilityService","serviceSetting",function(a,b,c,d,e){a.loginDetail={},a.loginAlerts=[],a.loginClick=function(e){e.preventDefault(),e.stopPropagation();var f=b.login(a.loginDetail);f.then(function(a){c.path("/product")},function(b){var c=d.constructAlerts([b],"danger");d.pushArray(a.loginAlerts,c)})},a.authExternalProvider=function(b){var c=location.protocol+"//"+location.host+"/authcomplete.html",d=e.apiServiceBaseUri+"/api/Account/ExternalLogin?provider="+b+"&responseType=token&redirect_uri="+c;window.$windowScope=a;window.open(d,"Authenticate Account","location=0,status=0,width=600,height=750")},a.authCompletedCB=function(d){a.$apply(function(){if("False"===d.haslocalaccount)b.logOut(),b.externalAuthData={provider:d.provider,userName:d.external_user_name,externalAccessToken:d.external_access_token},c.path("/associate");else{var e={provider:d.provider,externalAccessToken:d.external_access_token};b.obtainAccessToken(e).then(function(a){c.path("/product")},function(b){a.message=b.error_description,alert(a.message)})}})},a.closeAlert=function(b){a.loginAlerts.splice(b,1)}}]),app.controller("homeController",["$scope","$location",function(a,b){}]),app.controller("productController",["$scope","$location","productService",function(a,b,c){a.products=[],c.getProduct().then(function(b){a.products=b.Products},function(a){alert(a)})}]),app.controller("signupController",["$scope","authenticationService","$location","utilityService","$interval",function(a,b,c,d,e){a.signupDetail={email:"",password:"",confirmPassword:""},a.signupSuccess=!1,a.signupAlerts=[],a.countDown=3,a.signupClick=function(f){f.preventDefault(),f.stopPropagation();var g=b.signup(a.signupDetail);g.then(function(b){a.signupSuccess=!0,a.counter=e(function(){a.countDown=a.countDown-1,a.countDown<=0&&(e.cancel(a.counter),c.path("/login"))},1e3)},function(b){var c=[];angular.forEach(b,function(a,b){angular.forEach(a,function(a,b){c.push(a)})});var e=d.constructAlerts(c,"danger");d.pushArray(a.signupAlerts,e)})},a.closeAlert=function(b){a.signupAlerts.splice(b,1)}}]),app.controller("associateController",["$scope","authenticationService","$location","utilityService","serviceSetting","$interval",function(a,b,c,d,e,f){a.savedSuccessfully=!1,a.signupAlerts=[],a.countDown=3,a.registerData={Email:b.externalAuthData.userName,Provider:b.externalAuthData.provider,ExternalAccessToken:b.externalAuthData.externalAccessToken},a.registerExternal=function(){b.registerExternal(a.registerData).then(function(b){a.savedSuccessfully=!0,a.counter=f(function(){a.countDown=a.countDown-1,a.countDown<=0&&(f.cancel(a.counter),c.path("/product"))},1e3)},function(b){var c=[];angular.forEach(b,function(a,b){angular.forEach(a,function(a,b){c.push(a)})});var e=d.constructAlerts(c,"danger");d.pushArray(a.signupAlerts,e)})},a.closeAlert=function(b){a.signupAlerts.splice(b,1)}}]);